# Discord VC Tracker プロジェクトルール

## 📋 ドキュメント管理ルール

### 仕様書作成の原則
**すべての仕様書は非エンジニアでも理解できるように作成すること**

#### 仕様書に必須の要素
1. **概要説明** - 何をするプログラムかを身近な例えで説明
2. **Input/Output** - 入力と出力を明確に記載
3. **処理フロー** - 図や箇条書きで分かりやすく
4. **具体例** - 実際の使用例を提示
5. **FAQ** - よくある質問への回答
6. **トラブルシューティング** - 問題解決の手順

#### Input/Outputセクションの書き方
```markdown
## 📥 Input（入力）
| 項目 | 説明 | 例 |
|------|------|-----|
| 入力データ | 何を受け取るか | 具体例 |

## 📤 Output（出力）
| 項目 | 説明 | 例 |
|------|------|-----|
| 出力データ | 何を返すか | 具体例 |
```

### 仕様書の配置ルール
**ソースコードの階層構造に合わせて仕様書を配置すること**

#### 配置例
- `src/discord_client.py` → `docs/specs/src/discord_client.md`
- `src/sheets_client.py` → `docs/specs/src/sheets_client.md`
- `src/slack_notifier.py` → `docs/specs/src/slack_notifier.md`
- `discord_attendance_collector.py` → `docs/specs/discord_attendance_collector.md`
- `tests/test_discord_client.py` → `docs/specs/tests/test_discord_client.md`

### 必須ドキュメント更新
開発・機能追加・修正を行った際は、必ず以下のドキュメントを作成・更新すること:

1. **README.md** - プロジェクト概要とセットアップ手順を更新
2. **docs/OVERVIEW.md** - システム全体の概要を更新
3. **個別仕様書** - 各モジュール/機能ごとの詳細仕様書を作成・更新

### ドキュメント更新タイミング
- **新機能追加時**: 実装前に仕様書作成 → 実装 → ドキュメント更新
- **バグ修正時**: 修正内容を仕様書に反映
- **リファクタリング時**: 変更点を仕様書に反映

### ドキュメント構成
```
project/
├── README.md                    # プロジェクト概要
├── docs/
│   ├── OVERVIEW.md             # システム全体概要
│   ├── DEVELOPMENT.md          # 開発環境ガイド
│   ├── SECURITY.md             # セキュリティガイド
│   ├── specs/                  # 個別詳細仕様書
│   │   ├── discord_attendance_collector.md       # メイン処理
│   │   ├── src/                # srcディレクトリの仕様書
│   │   │   ├── discord_client.md
│   │   │   ├── sheets_client.md
│   │   │   └── slack_notifier.md
│   │   └── tests/              # テストの仕様書
│   │       └── test_spec.md
│   └── todo-archive.md         # 完了TODOアーカイブ
└── .claude/
    └── CLAUDE.md               # このファイル
```

### 仕様書テンプレート
```markdown
# [モジュール名]仕様書

## 📌 このドキュメントについて
[非エンジニアでも理解できる説明]

## 📥 Input（入力）
| 項目 | 型 | 説明 | 例 |
|------|-----|------|-----|
| [入力名] | [型] | [説明] | [具体例] |

## 📤 Output（出力）
| 項目 | 型 | 説明 | 例 |
|------|-----|------|-----|
| [出力名] | [型] | [説明] | [具体例] |

## 🔧 処理の流れ
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 💡 使用例
[実際の使用例を記載]

## ⚠️ 注意事項
[注意すべき点]

## ❓ FAQ
[よくある質問と回答]
```

## 💻 コーディング規約

### Python開発
- **バージョン**: Python 3.12（discord.pyの互換性のため3.13は使用しない）
- **フォーマッター**: Black
- **リンター**: Flake8
- **型チェック**: mypy
- **Discord API**: discord.py を使用（Python 3.12環境必須）

### コメント規約
- すべてのコードに日本語の行末コメントを追加
- 初心者にも理解できる平易な説明を心がける
- 複雑なロジックには詳細な説明を追加

### 命名規則
- **クラス名**: PascalCase (例: `DiscordVCPoller`)
- **関数名**: snake_case (例: `get_vc_members`)
- **定数**: UPPER_SNAKE_CASE (例: `MAX_RETRY_COUNT`)
- **変数**: snake_case (例: `user_name`)

### テンプレートとコード分離の原則
- **UIテキストやメッセージは設定ファイルに集約**
  - Slackメッセージ、エラーメッセージなどはJSONファイルで管理
  - `config/slack_block_kit_templates.json`などの設定ファイルを活用
- **コード内でのハードコーディング禁止**
  - メッセージテキストを直接コードに書かない
  - 設定値は環境変数または設定ファイルから読み込む
- **重複の排除**
  - 同じメッセージやテンプレートを複数箇所で定義しない
  - 一元管理により保守性を向上

## 🔒 セキュリティ

### 認証情報の取り扱い
- トークンや認証情報は**絶対にコミットしない**
- 環境変数またはGitHub Secretsで管理
- `.gitignore`に必ず追加

### ログ出力
- 認証情報は**マスキング**して出力
- 個人情報は最小限に留める

## 🧪 テスト

### テスト作成ルール
- 新機能追加時は必ずユニットテストを作成
- テストカバレッジ85%以上を目標
- モックを活用して外部依存を排除

### テスト実行
```bash
# ユニットテスト実行
pytest tests/

# カバレッジ確認
pytest --cov=src tests/
```

## 📝 コミットメッセージ

### フォーマット
```
<type>: <subject>

<body>
```

### タイプ
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント更新
- `style`: コード整形
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: ビルド・設定変更

### 例
```
feat: Discord VCメンバー取得機能を追加

- DiscordVCPollerクラスを実装
- 指定VCのメンバーリストを取得
- エラーハンドリングとリトライ機能を追加
```

## 🚀 デプロイ

### GitHub Actions
- `main`ブランチへのマージで自動デプロイ
- Pull Request時にテスト自動実行
- Secrets設定を事前に確認

## 📊 モニタリング

### ログレベル
- **本番環境**: INFO以上
- **開発環境**: DEBUG以上

### アラート条件
- 3回連続でエラー発生
- API Rate Limit到達
- 認証エラー発生

## 🔧 GitHub Actions設定

### ワークフロー作成ルール
- **name フィールドは必ず日本語で記載**
- **各ステップの name も日本語で記載**
- わかりやすい名前を付ける

#### 例
```yaml
name: Discord Bot 接続テスト  # 日本語で記載

jobs:
  test:
    name: テスト実行  # 日本語で記載
    steps:
    - name: コードをチェックアウト  # 日本語で記載
      uses: actions/checkout@v4
    - name: Pythonセットアップ  # 日本語で記載
      uses: actions/setup-python@v5
```

## 🔄 GitHub Actions エラー自動修正ルール

### CI/CDエラー時の自動修正フロー
pushした後、GitHub Actionsでエラーが発生した場合は以下の手順で自動的に修正を繰り返すこと:

1. **エラー確認**: `gh run list`と`gh run view`でワークフロー実行結果を確認
2. **ログ解析**: エラーログを詳細に調査し、根本原因を特定
3. **修正実施**: エラーの原因となっているコードを修正
4. **再プッシュ**: 修正をコミットしてプッシュ
5. **結果確認**: 再度GitHub Actionsの結果を確認
6. **繰り返し**: エラーが解消されるまで1-5を繰り返す

### 自動修正の実行手順
```bash
# 1. 最新のワークフロー実行結果を確認
gh run list --limit 1

# 2. 失敗したジョブの詳細ログを取得
gh run view [RUN_ID] --log-failed

# 3. エラー内容を分析して修正
# (コード修正)

# 4. 修正をコミット＆プッシュ
git add .
git commit -m "fix: GitHub Actionsエラーを修正"
git push

# 5. 新しいワークフロー実行を監視
gh run watch
```

### よくあるエラーと対処法
- **依存関係エラー**: `requirements.txt`や`package.json`を更新
- **環境変数エラー**: GitHub Secretsの設定を確認、ワークフローファイルで環境変数を追加
- **テスト失敗**: テストコードまたは実装コードを修正
- **構文エラー**: YAMLやコードの構文を修正
- **権限エラー**: トークンやパーミッションの設定を確認

### 修正時の注意事項
- エラーメッセージを正確に読み取る
- 修正は小さく、一つずつ行う
- 各修正後は必ずコミットメッセージに修正内容を明記
- 最大5回まで自動修正を試み、それでも解決しない場合は詳細な調査を行う