# ========================================
# Discord VC â†’ Google Drive CSV çµ±åˆãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ========================================
# æ¦‚è¦: å®Ÿéš›ã®Discord VCãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—ã—ã¦Google Driveä¸Šã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²ã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆ
#       DriveCSVClientã‚’ä½¿ç”¨ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆ
#       ãƒ•ã‚©ãƒ«ãƒ€éšŽå±¤ï¼ˆdiscord_mokumoku_tracker/csv/{VCå}/{ç’°å¢ƒ}.csvï¼‰ã®è‡ªå‹•ä½œæˆã‚’ç¢ºèª
#       æ‰‹å‹•å®Ÿè¡Œã€PRä½œæˆæ™‚ã€ã‚³ãƒ¼ãƒ‰ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
# ========================================

name: CSVçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆVCâ†’Drive CSVï¼‰  # GitHub Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å

on:  # ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å®šç¾©
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:  # GitHub Actionsç”»é¢ã‹ã‚‰æ‰‹å‹•ã§å®Ÿè¡Œå¯èƒ½
    inputs:  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      debug_mode:  # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–'  # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜Ž
        required: false  # ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«
        default: 'true'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ‡ãƒãƒƒã‚°ON
        type: boolean  # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—
      cleanup_test_files:  # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        description: 'ãƒ†ã‚¹ãƒˆå¾Œã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤'  # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜Ž
        required: false  # ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«
        default: 'true'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‰Šé™¤ã™ã‚‹
        type: boolean  # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—

  # ç¾åœ¨ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åˆ¶é™ã«ã‚ˆã‚Šæ‰‹å‹•å®Ÿè¡Œã®ã¿
  # PRã¨pushæ™‚ã®è‡ªå‹•å®Ÿè¡Œã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  # ï¼ˆService Accounts do not have storage quotaã‚¨ãƒ©ãƒ¼ã®è§£æ±ºãŒå¿…è¦ï¼‰
  # pull_request:  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆãƒ»æ›´æ–°æ™‚ã«å®Ÿè¡Œ
  #   branches: [main, master]  # main/masterãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã®ã¿å¯¾è±¡
  #   paths:  # ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
  #     - 'src/drive_csv_client.py'  # CSVã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  #     - 'src/discord_client.py'  # Discordã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  #     - 'discord_attendance_collector.py'  # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  #     - 'config.py'  # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
  #     - 'requirements.txt'  # ä¾å­˜é–¢ä¿‚
  #     - '.github/workflows/tst_csv_integration.yml'  # ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“
  # push:  # ã‚³ãƒ¼ãƒ‰ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
  #   branches: [main, master]  # main/masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã®ã¿å¯¾è±¡
  #   paths:  # ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
  #     - 'src/drive_csv_client.py'
  #     - 'src/discord_client.py'
  #     - 'discord_attendance_collector.py'
  #     - 'config.py'
  #     - 'requirements.txt'

jobs:  # å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã®å®šç¾©
  csv-integration-test:  # ã‚¸ãƒ§ãƒ–ID
    runs-on: ubuntu-latest  # Ubuntuæœ€æ–°ç‰ˆã®ä»®æƒ³ç’°å¢ƒã§å®Ÿè¡Œ
    timeout-minutes: 10  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    name: Discord VC â†’ Google Drive CSV çµ±åˆãƒ†ã‚¹ãƒˆ  # ã‚¸ãƒ§ãƒ–ã®è¡¨ç¤ºå

    steps:  # ã‚¸ãƒ§ãƒ–å†…ã§å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã®å®šç¾©
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ  # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      uses: actions/checkout@v4  # GitHubå…¬å¼ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³v4ã‚’ä½¿ç”¨

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  # ã‚¹ãƒ†ãƒƒãƒ—2: Pythonç’°å¢ƒã®æº–å‚™
      uses: actions/setup-python@v5  # Pythonå…¬å¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³v5ã‚’ä½¿ç”¨
      with:  # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        python-version: '3.11'  # Python 3.11ã‚’ä½¿ç”¨
        cache: 'pip'  # pipã®ä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é«˜é€ŸåŒ–

    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  # ã‚¹ãƒ†ãƒƒãƒ—3: å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        python -m pip install --upgrade pip  # pipã‚’æœ€æ–°ç‰ˆã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
        pip install -r requirements.txt  # æœ¬ç•ªç”¨ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install pytest pytest-asyncio pytest-cov  # ãƒ†ã‚¹ãƒˆç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

    - name: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONä½œæˆ  # ã‚¹ãƒ†ãƒƒãƒ—4: Googleèªè¨¼ç”¨ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      env:  # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}  # Base64å½¢å¼ã®èªè¨¼æƒ…å ±
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        if [ -z "$TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" ]; then
          echo "âš ï¸ TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
        else
          echo "ðŸ” Googleèªè¨¼æƒ…å ±ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­..."  # å‡¦ç†é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          echo "$TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > service_account.json  # Base64ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          chmod 600 service_account.json  # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’åˆ¶é™ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
          echo "âœ… service_account.jsonã‚’ä½œæˆã—ã¾ã—ãŸ"
        fi

    - name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯  # ã‚¹ãƒ†ãƒƒãƒ—5: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        echo "ðŸ“‹ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"  # ãƒã‚§ãƒƒã‚¯é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        MISSING_VARS=""

        # Discord Bot Token
        if [ -n "${{ secrets.TST_DISCORD_BOT_TOKEN }}" ]; then
          echo "  âœ… TST_DISCORD_BOT_TOKEN: è¨­å®šæ¸ˆã¿"
        else
          echo "  âŒ TST_DISCORD_BOT_TOKEN: æœªè¨­å®š"
          MISSING_VARS="$MISSING_VARS TST_DISCORD_BOT_TOKEN"
        fi

        # VCãƒãƒ£ãƒ³ãƒãƒ«ID
        if [ -n "${{ secrets.TST_ALLOWED_VOICE_CHANNEL_IDS }}" ]; then
          echo "  âœ… TST_ALLOWED_VOICE_CHANNEL_IDS: è¨­å®šæ¸ˆã¿"
        else
          echo "  âŒ TST_ALLOWED_VOICE_CHANNEL_IDS: æœªè¨­å®š"
          MISSING_VARS="$MISSING_VARS TST_ALLOWED_VOICE_CHANNEL_IDS"
        fi

        # Google Drive ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼ˆconfig.pyã§è¨­å®šæ¸ˆã¿ï¼‰
        echo "  âœ… TST_GOOGLE_DRIVE_FOLDER_PATH: config.pyã§'discord_mokumoku_tracker/csv'ã¨ã—ã¦è¨­å®šæ¸ˆã¿"

        if [ -n "$MISSING_VARS" ]; then
          echo ""
          echo "âš ï¸ è­¦å‘Š: å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:$MISSING_VARS"
          echo "ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
        fi

    - name: CSVçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ  # ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ¡ã‚¤ãƒ³ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      env:  # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        # ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®è¨­å®š
        TST_DISCORD_BOT_TOKEN: ${{ secrets.TST_DISCORD_BOT_TOKEN }}  # Discord Botãƒˆãƒ¼ã‚¯ãƒ³
        TST_ALLOWED_VOICE_CHANNEL_IDS: ${{ secrets.TST_ALLOWED_VOICE_CHANNEL_IDS }}  # ç›£è¦–å¯¾è±¡VCãƒãƒ£ãƒ³ãƒãƒ«ID
        TST_GOOGLE_DRIVE_FOLDER_PATH: discord_mokumoku_tracker/csv  # Google Driveãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹
        TST_GOOGLE_SERVICE_ACCOUNT_JSON: service_account.json  # èªè¨¼ç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        TST_SLACK_BOT_TOKEN: ${{ secrets.TST_SLACK_BOT_TOKEN }}  # Slack Botãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        TST_SLACK_CHANNEL_ID: ${{ secrets.TST_SLACK_CHANNEL_ID }}  # Slackãƒãƒ£ãƒ³ãƒãƒ«IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        LOG_LEVEL: ${{ github.event.inputs.debug_mode == 'true' && '1' || '2' }}  # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
        PYTHONPATH: ${{ github.workspace }}  # Pythonãƒ‘ã‚¹ã‚’è¨­å®š
        CLEANUP_TEST_FILES: ${{ github.event.inputs.cleanup_test_files }}  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ãƒ©ã‚°
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        echo "ðŸš€ Discord VC â†’ Google Drive CSV çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."  # å®Ÿè¡Œé–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§è¨˜è¿°ï¼‰
        cat > test_csv_integration.py << 'EOF'
        import asyncio
        import os
        import sys
        from datetime import datetime
        from pathlib import Path
        from unittest.mock import patch, MagicMock

        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
        sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
        sys.path.insert(0, os.path.join(os.path.dirname(os.path.abspath(__file__)), 'src'))

        from discord_attendance_collector import main as poll_once_main
        from src.drive_csv_client import DriveCSVClient
        from src.slack_notifier import SlackNotifier
        from config import EnvConfig, Environment

        async def test_csv_integration():
            """CSVçµ±åˆãƒ†ã‚¹ãƒˆ"""
            print("=" * 60)
            print("Discord VC â†’ Google Drive CSV çµ±åˆãƒ†ã‚¹ãƒˆ")
            print("=" * 60)
            print()

            # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
            print("ðŸ“‹ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:")
            required_vars = ['TST_DISCORD_BOT_TOKEN', 'TST_ALLOWED_VOICE_CHANNEL_IDS']
            for var in required_vars:
                value = os.getenv(var)
                if value:
                    print(f"  âœ… {var}: è¨­å®šæ¸ˆã¿")
                else:
                    print(f"  âŒ {var}: æœªè¨­å®š")
                    return False

            # Google Driveè¨­å®šã‚’ç¢ºèª
            drive_config = EnvConfig.get_google_drive_config(Environment.TST)
            print(f"  âœ… Google Drive ãƒ•ã‚©ãƒ«ãƒ€: {drive_config['folder_path']}")
            print(f"  âœ… ç’°å¢ƒå: {drive_config['env_name']}")

            # ãƒ†ã‚¹ãƒˆç”¨ã®VCãƒãƒ£ãƒ³ãƒãƒ«åã‚’è¨˜éŒ²
            test_vc_names = []
            test_folder_path = f"{drive_config['folder_path']}_TEST_{datetime.now().strftime('%Y%m%d_%H%M%S')}"

            # DriveCSVClientã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ãƒ†ã‚¹ãƒˆç”¨ã«å¤‰æ›´
            original_init = DriveCSVClient.__init__
            def mock_init(self, service_account_json, base_folder_path, env_name):
                # ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã«å¤‰æ›´
                original_init(self, service_account_json, test_folder_path, env_name)
                print(f"  ðŸ“ ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚©ãƒ«ãƒ€: {test_folder_path}/{{VCå}}/{env_name}.csv")

            # upsert_presenceã®å¾Œå‡¦ç†ã‚’è¨˜éŒ²
            original_upsert = DriveCSVClient.upsert_presence
            def mock_upsert(self, members):
                # VCãƒãƒ£ãƒ³ãƒãƒ«åã‚’è¨˜éŒ²
                for member in members:
                    vc_name = member.get('vc_name', 'unknown')
                    if vc_name not in test_vc_names:
                        test_vc_names.append(vc_name)
                # å…ƒã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
                result = original_upsert(self, members)
                print(f"  âœ… CSVè¨˜éŒ²å®Œäº†: {result['new']}ä»¶æ–°è¦, {result['updated']}ä»¶æ›´æ–°")
                return result

            # Slacké€šçŸ¥ã‚’ãƒ¢ãƒƒã‚¯
            def mock_slack_notification(user_name, total_days):
                print(f"  ðŸ’¬ ãƒ¢ãƒƒã‚¯: Slacké€šçŸ¥ - {user_name} (é€šç®—{total_days}æ—¥ç›®)")
                return True

            print("\nðŸš€ discord_attendance_collector.main()ã‚’å®Ÿè¡Œä¸­...")

            with patch.object(DriveCSVClient, '__init__', mock_init):
                with patch.object(DriveCSVClient, 'upsert_presence', mock_upsert):
                    with patch.object(SlackNotifier, 'send_login_notification', mock_slack_notification):
                        try:
                            # ãƒ†ã‚¹ãƒˆç’°å¢ƒï¼ˆenv=1ï¼‰ã§å®Ÿè¡Œ
                            await poll_once_main(env_arg=1)
                            print("âœ… discord_attendance_collector.main()ãŒæ­£å¸¸ã«å®Œäº†")
                        except Exception as e:
                            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
                            import traceback
                            traceback.print_exc()
                            return False

            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if os.getenv('CLEANUP_TEST_FILES', 'true').lower() == 'true':
                print(f"\nðŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—")
                try:
                    # DriveCSVClientã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
                    service_account_json = os.getenv('TST_GOOGLE_SERVICE_ACCOUNT_JSON', 'service_account.json')
                    csv_client = DriveCSVClient(service_account_json, test_folder_path, 'TST')
                    csv_client.connect()

                    # ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
                    if csv_client.base_folder_id:
                        csv_client.service.files().delete(fileId=csv_client.base_folder_id).execute()
                        print(f"  âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤: {test_folder_path}")
                except Exception as e:
                    print(f"  âš ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
            else:
                print(f"\nðŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒã•ã‚Œã¾ã™: {test_folder_path}")

            return True

        # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
        if __name__ == "__main__":
            try:
                result = asyncio.run(test_csv_integration())
                if result:
                    print("\nâœ… CSVçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ")
                    sys.exit(0)
                else:
                    print("\nâŒ CSVçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—")
                    sys.exit(1)
            except Exception as e:
                print(f"\nâŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}")
                import traceback
                traceback.print_exc()
                sys.exit(1)
        EOF

        # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        python test_csv_integration.py

    - name: ãƒ†ã‚¹ãƒˆæˆåŠŸã‚µãƒžãƒªãƒ¼  # ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®å‡¦ç†
      if: success()  # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        echo "âœ… CSVçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ"  # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        echo ""  # ç©ºè¡Œ
        echo "ç¢ºèªé …ç›®:"  # ç¢ºèªé …ç›®ã®ãƒ˜ãƒƒãƒ€ãƒ¼
        echo "  âœ… Discord BotæŽ¥ç¶šï¼ˆå®Ÿéš›ã®Botä½¿ç”¨ï¼‰"  # DiscordæŽ¥ç¶šç¢ºèª
        echo "  âœ… VCãƒ¡ãƒ³ãƒãƒ¼å–å¾—"  # ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ç¢ºèª
        echo "  âœ… Google Drive APIæŽ¥ç¶š"  # Drive APIæŽ¥ç¶šç¢ºèª
        echo "  âœ… ãƒ•ã‚©ãƒ«ãƒ€éšŽå±¤ã®è‡ªå‹•ä½œæˆ"  # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆç¢ºèª
        echo "  âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²"  # CSVè¨˜éŒ²ç¢ºèª
        echo "  âœ… ç’°å¢ƒåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆTST.csvï¼‰ã®ä½œæˆ"  # ãƒ•ã‚¡ã‚¤ãƒ«åç¢ºèª
        echo ""
        echo "ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ :"
        echo "  discord_mokumoku_tracker/"
        echo "  â””â”€â”€ csv/"
        echo "      â””â”€â”€ {VCãƒãƒ£ãƒ³ãƒãƒ«å}/"
        echo "          â””â”€â”€ TST.csv"

    - name: ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚µãƒžãƒªãƒ¼  # ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®å‡¦ç†
      if: failure()  # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        echo "âŒ CSVçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—"  # å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        echo ""  # ç©ºè¡Œ
        echo "ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"  # ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ˜ãƒƒãƒ€ãƒ¼
        echo "1. GitHub Secretsã®è¨­å®šã‚’ç¢ºèª"  # å¯¾å‡¦æ³•1
        echo "   - TST_DISCORD_BOT_TOKEN"  # Discordè¨­å®š
        echo "   - TST_ALLOWED_VOICE_CHANNEL_IDS"  # VCãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š
        echo "   - TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64"  # èªè¨¼æƒ…å ±è¨­å®š
        echo ""  # ç©ºè¡Œ
        echo "2. Google APIã®æœ‰åŠ¹åŒ–ã‚’ç¢ºèª"  # å¯¾å‡¦æ³•2
        echo "   - Google Drive API"  # Drive API
        echo ""  # ç©ºè¡Œ
        echo "3. Discord Botã®æ¨©é™ã‚’ç¢ºèª"  # å¯¾å‡¦æ³•3
        echo "   - SERVER MEMBERS INTENTãŒæœ‰åŠ¹ã‹"  # æ¨©é™ç¢ºèª
        echo ""  # ç©ºè¡Œ
        echo "4. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã‚’ç¢ºèª"  # å¯¾å‡¦æ³•4
        echo "   - Google Driveã¸ã®æ›¸ãè¾¼ã¿æ¨©é™"  # Driveæ¨©é™
        exit 1  # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰1ã§çµ‚äº†

    - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—  # ã‚¹ãƒ†ãƒƒãƒ—9: å¾Œå‡¦ç†ï¼ˆæ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ï¼‰
      if: always()  # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå¸¸ã«å®Ÿè¡Œ
      run: |  # ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        rm -f service_account.json  # Googleèªè¨¼ç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
        rm -f test_csv_integration.py  # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤