name: Authentication Tests

on:
  # 手動実行を許可（ボタンから実行可能）
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'デバッグモードで実行'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # PRとpush時に実行
  pull_request:
    paths:
      - 'tests/auth_tests/**'
      - 'config.py'
      - '.github/workflows/test_auth.yml'
  push:
    branches:
      - main
      - master
    paths:
      - 'tests/auth_tests/**'
      - 'config.py'
      - '.github/workflows/test_auth.yml'

jobs:
  test-google-sheets-auth:
    runs-on: ubuntu-latest
    name: Google Sheets Authentication Test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup Google Service Account (Test)
      if: env.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 != ''
      env:
        TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
      run: |
        echo "$TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > test_service_account.json
        echo "TEST_GOOGLE_SERVICE_ACCOUNT_JSON=test_service_account.json" >> $GITHUB_ENV
    
    - name: Setup Google Service Account (Production)
      if: env.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 != '' && env.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 == ''
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
      run: |
        echo "$GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > service_account.json
        echo "GOOGLE_SERVICE_ACCOUNT_JSON=service_account.json" >> $GITHUB_ENV
    
    - name: Run Google Sheets Authentication Test
      env:
        # テスト環境の設定
        TEST_GOOGLE_SHEET_NAME: ${{ secrets.TEST_GOOGLE_SHEET_NAME }}
        TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        
        # 本番環境の設定（テスト環境がない場合のフォールバック）
        GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        
        # GitHub Actions環境であることを示すフラグ
        GITHUB_ACTIONS: 'true'
      run: |
        echo "🔍 環境変数の確認"
        echo "TEST_GOOGLE_SHEET_NAME: ${TEST_GOOGLE_SHEET_NAME:+SET}"
        echo "GOOGLE_SHEET_NAME: ${GOOGLE_SHEET_NAME:+SET}"
        echo ""
        echo "🚀 認証テストを実行"
        python tests/auth_tests/test_google_sheets_auth.py
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: auth-test-results
        path: |
          *.log
          *.txt
        retention-days: 7