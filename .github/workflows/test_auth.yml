name: Google Sheets 接続テスト  # ワークフローの名前（GitHubのActionsタブに表示される）

on:  # このワークフローが実行されるタイミングの設定
  # 手動実行を許可
  workflow_dispatch:  # GitHubのActionsタブから手動で実行できるようにする設定
  
  # PRとpush時に必ず実行
  pull_request:  # プルリクエストが作成・更新されたときに実行
    branches: [main, master]  # main/masterブランチへのPRのみ対象
  push:  # コードがプッシュされたときに実行
    branches: [main, master]  # main/masterブランチへのプッシュのみ対象

jobs:  # 実行するジョブ（作業）の定義
  test-connection:  # ジョブの名前（任意の名前をつけられる）
    runs-on: ubuntu-latest  # Ubuntu最新版の仮想環境で実行
    name: Google Sheets 接続テスト  # ジョブの表示名
    
    steps:  # ジョブ内で実行するステップ（手順）の定義
    - name: コードをチェックアウト  # ステップ1: コードを取得
      uses: actions/checkout@v4  # GitHubが提供するコード取得アクションを使用
    
    - name: Pythonセットアップ  # ステップ2: Python環境をセットアップ
      uses: actions/setup-python@v5  # Pythonセットアップ用の公式アクションを使用
      with:  # アクションへの設定
        python-version: '3.11'  # Python 3.11を使用
    
    - name: 依存関係インストール  # ステップ3: 必要なライブラリをインストール
      run: |  # シェルコマンドを実行
        python -m pip install --upgrade pip  # pipを最新版にアップグレード
        pip install gspread google-auth python-dotenv  # Google Sheets接続に必要なライブラリをインストール
    
    - name: 接続テスト実行  # ステップ4: 接続テストを実行
      env:  # 環境変数の設定
        TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}  # テスト環境用の認証情報
        GITHUB_ACTIONS: 'true'  # GitHub Actions環境であることを示すフラグ
        GH_TOKEN: ${{ github.token }}  # GitHub CLIで使用するトークン（Secrets一覧取得用）
      run: |  # テストスクリプトを実行
        echo "🔍 Google Sheets接続テストを実行（テスト環境）"  # 実行開始メッセージを表示
        python tst/auth_tests/test_google_sheets_ci.py  # テストスクリプトを実行
        
    - name: テスト成功  # ステップ5: テスト成功時の処理
      if: success()  # 前のステップが成功した場合のみ実行
      run: |  # 成功メッセージを表示
        echo "✅ Google Sheets接続テスト成功"  # 成功マークを表示
        echo "テスト環境のGoogle Sheetsへの接続が確認されました"  # 詳細メッセージ
        
    - name: テスト失敗  # ステップ6: テスト失敗時の処理
      if: failure()  # 前のステップが失敗した場合のみ実行
      run: |  # エラーメッセージを表示
        echo "❌ Google Sheets接続テスト失敗"  # 失敗マークを表示
        echo "GitHub Secretsの設定を確認してください:"  # 対処法を案内
        echo "  - GOOGLE_SERVICE_ACCOUNT_JSON_BASE64"  # 確認すべき設定名
        exit 1  # エラーコード1で終了（失敗を明示）