name: Authentication Tests

on:
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯ï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # PRã¨pushæ™‚ã«å®Ÿè¡Œ
  pull_request:
    paths:
      - 'tests/auth_tests/**'
      - 'config.py'
      - '.github/workflows/test_auth.yml'
  push:
    branches:
      - main
      - master
    paths:
      - 'tests/auth_tests/**'
      - 'config.py'
      - '.github/workflows/test_auth.yml'

jobs:
  test-google-sheets-auth:
    runs-on: ubuntu-latest
    name: Google Sheets Authentication Test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup Google Service Account (Test)
      if: env.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 != ''
      env:
        TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
      run: |
        echo "$TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > test_service_account.json
        echo "TEST_GOOGLE_SERVICE_ACCOUNT_JSON=test_service_account.json" >> $GITHUB_ENV
    
    - name: Setup Google Service Account (Production)
      if: env.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 != '' && env.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 == ''
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
      run: |
        echo "$GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > service_account.json
        echo "GOOGLE_SERVICE_ACCOUNT_JSON=service_account.json" >> $GITHUB_ENV
    
    - name: Run Google Sheets Authentication Test
      env:
        # ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®š
        TEST_GOOGLE_SHEET_NAME: ${{ secrets.TEST_GOOGLE_SHEET_NAME }}
        TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TEST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        
        # æœ¬ç•ªç’°å¢ƒã®è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        
        # GitHub Actionsç’°å¢ƒã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
        GITHUB_ACTIONS: 'true'
      run: |
        echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª"
        echo "TEST_GOOGLE_SHEET_NAME: ${TEST_GOOGLE_SHEET_NAME:+SET}"
        echo "GOOGLE_SHEET_NAME: ${GOOGLE_SHEET_NAME:+SET}"
        echo ""
        echo "ğŸš€ èªè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
        python tests/auth_tests/test_google_sheets_auth.py
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: auth-test-results
        path: |
          *.log
          *.txt
        retention-days: 7