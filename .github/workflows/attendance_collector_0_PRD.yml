name: å‡ºå¸­è¨˜éŒ²åé›†ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

on:
  schedule:
    # JST 4:00 (UTC 19:00 å‰æ—¥) ã‹ã‚‰ JST 6:55 (UTC 21:55 å‰æ—¥) ã¾ã§5åˆ†ã”ã¨ã«å®Ÿè¡Œ
    # cronå¼: åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥ï¼ˆ0:æ—¥æ›œã€1:æœˆæ›œ...6:åœŸæ›œï¼‰
    - cron: '*/5 19-21 * * *'   # JST 4:00-6:55ï¼ˆæ¯æ—¥å®Ÿè¡Œã€Pythonå´ã§æ—¥æ›œåˆ¤å®šï¼‰ã€5åˆ†é–“éš”
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-and-run:
    name: å‡ºå¸­è¨˜éŒ²åé›†
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: æ›œæ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æ›œæ—¥ã®ã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      id: weekday_check
      run: |
        python << 'EOF'
        import sys
        from datetime import datetime
        import pytz
        import os

        # JSTã§ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
        jst = pytz.timezone('Asia/Tokyo')
        today = datetime.now(jst)
        weekday_names = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥']

        # æ—¥æ›œæ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æ›œæ—¥ã®ã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        is_sunday = today.weekday() == 6  # 6:æ—¥æ›œ

        print(f"JSTç¾åœ¨æ™‚åˆ»: {today.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ä»Šæ—¥ã¯{weekday_names[today.weekday()]}æ›œæ—¥ã§ã™")

        if is_sunday:
            print("æ—¥æ›œæ—¥ã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("skip=true\n")
        else:
            print("å‡ºå¸­è¨˜éŒ²åé›†ã‚’å®Ÿè¡Œã—ã¾ã™")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("skip=false\n")
        EOF

    - name: Discord VCå‡ºå¸­è¨˜éŒ²åé›†ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      if: steps.weekday_check.outputs.skip != 'true'
      env:
        DISCORD_BOT_TOKEN_0_PRD: ${{ secrets.DISCORD_BOT_TOKEN_0_PRD }}
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64_0_PRD: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64_0_PRD }}
        GOOGLE_SHARED_DRIVE_ID_0_PRD: ${{ secrets.GOOGLE_SHARED_DRIVE_ID_0_PRD }}
        DISCORD_VOICE_CHANNEL_IDS_0_PRD: ${{ secrets.DISCORD_VOICE_CHANNEL_IDS_0_PRD }}
      run: |
        echo "æœ¬ç•ªç’°å¢ƒã§å‡ºå¸­è¨˜éŒ²ã‚’åé›†ã—ã¾ã™"
        python discord_attendance_collector.py --env 0

    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
      if: success() && steps.weekday_check.outputs.skip != 'true'
      run: |
        echo "âœ… å‡ºå¸­è¨˜éŒ²ã®åé›†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰"

    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
      if: failure()
      run: |
        echo "âŒ å‡ºå¸­è¨˜éŒ²ã®åé›†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰"
        echo "ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

    - name: æ—¥æ›œæ—¥ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
      if: steps.weekday_check.outputs.skip == 'true'
      run: |
        echo "ğŸ“… æœ¬æ—¥ã¯æ—¥æ›œæ—¥ã®ãŸã‚ã€å‡ºå¸­è¨˜éŒ²åé›†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"