name: Discord Bot Connection Test

on:
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’é¸æŠ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - production
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: false
        type: boolean

jobs:
  test-discord-bot:
    runs-on: ubuntu-latest
    name: Discord Botæ¥ç¶šãƒ†ã‚¹ãƒˆ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install discord.py python-dotenv
    
    - name: Run Discord Bot Test (Test Environment)
      if: github.event.inputs.environment == 'test'
      env:
        TST_DISCORD_BOT_TOKEN: ${{ secrets.TST_DISCORD_BOT_TOKEN }}
        TST_ALLOWED_VOICE_CHANNEL_IDS: ${{ secrets.TST_ALLOWED_VOICE_CHANNEL_IDS }}
      run: |
        echo "ğŸ¤– Discord Botæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒï¼‰"
        python -c "
import discord
import asyncio
import os
import sys

async def test_bot():
    token = os.getenv('TST_DISCORD_BOT_TOKEN')
    channel_ids = os.getenv('TST_ALLOWED_VOICE_CHANNEL_IDS', '').split(',')
    
    if not token:
        print('âŒ ã‚¨ãƒ©ãƒ¼: TST_DISCORD_BOT_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')
        print('GitHub Secretsã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:')
        print('  - TST_DISCORD_BOT_TOKEN')
        return False
    
    print('âœ… ãƒˆãƒ¼ã‚¯ãƒ³: è¨­å®šæ¸ˆã¿')
    print(f'ğŸ“ ç›£è¦–å¯¾è±¡VCãƒãƒ£ãƒ³ãƒãƒ«: {len(channel_ids)}å€‹')
    
    intents = discord.Intents.default()
    intents.members = True
    intents.guilds = True
    
    client = discord.Client(intents=intents)
    
    @client.event
    async def on_ready():
        print(f'âœ… Botæ¥ç¶šæˆåŠŸ: {client.user}')
        print('ğŸ“Š æ¥ç¶šæ¸ˆã¿ã‚µãƒ¼ãƒãƒ¼:')
        for guild in client.guilds:
            print(f'  - {guild.name} (ID: {guild.id})')
            print(f'    ãƒ¡ãƒ³ãƒãƒ¼æ•°: {guild.member_count}')
            
            # VCãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±
            voice_channels = [ch for ch in guild.channels if isinstance(ch, discord.VoiceChannel)]
            print(f'    VCãƒãƒ£ãƒ³ãƒãƒ«æ•°: {len(voice_channels)}')
            
            # ç›£è¦–å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ã®ç¢ºèª
            for ch_id in channel_ids:
                if ch_id:
                    channel = guild.get_channel(int(ch_id))
                    if channel:
                        print(f'    âœ… ç›£è¦–å¯¾è±¡VC: {channel.name}')
                        if hasattr(channel, 'members'):
                            print(f'       ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼æ•°: {len(channel.members)}')
        
        await client.close()
    
    try:
        await client.start(token)
        return True
    except discord.LoginFailure:
        print('âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™')
        return False
    except Exception as e:
        print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')
        return False

success = asyncio.run(test_bot())
sys.exit(0 if success else 1)
        "
    
    - name: Run Discord Bot Test (Production Environment)
      if: github.event.inputs.environment == 'production'
      env:
        DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        ALLOWED_VOICE_CHANNEL_IDS: ${{ secrets.ALLOWED_VOICE_CHANNEL_IDS }}
      run: |
        echo "ğŸ¤– Discord Botæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰"
        echo "âš ï¸ æ³¨æ„: æœ¬ç•ªç’°å¢ƒã®Botã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™"
        python -c "
import discord
import asyncio
import os
import sys

async def test_bot():
    token = os.getenv('DISCORD_BOT_TOKEN')
    channel_ids = os.getenv('ALLOWED_VOICE_CHANNEL_IDS', '').split(',')
    
    if not token:
        print('âŒ ã‚¨ãƒ©ãƒ¼: DISCORD_BOT_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')
        print('GitHub Secretsã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:')
        print('  - DISCORD_BOT_TOKEN')
        return False
    
    print('âœ… ãƒˆãƒ¼ã‚¯ãƒ³: è¨­å®šæ¸ˆã¿')
    print(f'ğŸ“ ç›£è¦–å¯¾è±¡VCãƒãƒ£ãƒ³ãƒãƒ«: {len(channel_ids)}å€‹')
    
    intents = discord.Intents.default()
    intents.members = True
    intents.guilds = True
    
    client = discord.Client(intents=intents)
    
    @client.event
    async def on_ready():
        print(f'âœ… Botæ¥ç¶šæˆåŠŸ: {client.user}')
        print('ğŸ“Š æ¥ç¶šæ¸ˆã¿ã‚µãƒ¼ãƒãƒ¼:')
        for guild in client.guilds:
            print(f'  - {guild.name} (ID: {guild.id})')
            print(f'    ãƒ¡ãƒ³ãƒãƒ¼æ•°: {guild.member_count}')
            
            # VCãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±
            voice_channels = [ch for ch in guild.channels if isinstance(ch, discord.VoiceChannel)]
            print(f'    VCãƒãƒ£ãƒ³ãƒãƒ«æ•°: {len(voice_channels)}')
            
            # ç›£è¦–å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ã®ç¢ºèª
            for ch_id in channel_ids:
                if ch_id:
                    channel = guild.get_channel(int(ch_id))
                    if channel:
                        print(f'    âœ… ç›£è¦–å¯¾è±¡VC: {channel.name}')
                        if hasattr(channel, 'members'):
                            print(f'       ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼æ•°: {len(channel.members)}')
        
        await client.close()
    
    try:
        await client.start(token)
        return True
    except discord.LoginFailure:
        print('âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™')
        return False
    except Exception as e:
        print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')
        return False

success = asyncio.run(test_bot())
sys.exit(0 if success else 1)
        "
    
    - name: Test Success Summary
      if: success()
      run: |
        echo "âœ… Discord Botæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ"
        echo ""
        echo "ç¢ºèªé …ç›®:"
        echo "  âœ… Botãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§"
        echo "  âœ… ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š"
        echo "  âœ… VCãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹"
        echo "  âœ… ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®å–å¾—"
    
    - name: Test Failed Summary
      if: failure()
      run: |
        echo "âŒ Discord Botæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—"
        echo ""
        echo "ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
        echo "1. GitHub Secretsã®è¨­å®šã‚’ç¢ºèª"
        echo "   - ãƒ†ã‚¹ãƒˆç’°å¢ƒ: TST_DISCORD_BOT_TOKEN"
        echo "   - æœ¬ç•ªç’°å¢ƒ: DISCORD_BOT_TOKEN"
        echo ""
        echo "2. Botã®æ¨©é™ã‚’ç¢ºèª"
        echo "   - SERVER MEMBERS INTENT ãŒæœ‰åŠ¹ã‹"
        echo "   - BotãŒã‚µãƒ¼ãƒãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹"
        echo ""
        echo "3. ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª"
        echo "   - Discord Developer Portalã§å†ç”ŸæˆãŒå¿…è¦ã‹ã‚‚"
        exit 1