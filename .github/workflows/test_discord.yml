name: Discord Bot 接続テスト

on:
  # 手動実行を許可
  workflow_dispatch:
    inputs:
      environment:
        description: 'テスト環境を選択'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - production
      debug_mode:
        description: 'デバッグモード'
        required: false
        default: false
        type: boolean

jobs:
  test-discord-bot:
    runs-on: ubuntu-latest
    name: Discord Bot接続テスト
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install discord.py python-dotenv

    - name: Run Discord Bot Test (Test Environment)
      if: github.event.inputs.environment == 'test'
      env:
        TST_DISCORD_BOT_TOKEN: ${{ secrets.TST_DISCORD_BOT_TOKEN }}
        TST_ALLOWED_VOICE_CHANNEL_IDS: ${{ secrets.TST_ALLOWED_VOICE_CHANNEL_IDS }}
      run: |
        echo "🤖 Discord Bot接続テスト（テスト環境）"
        python tst/test_discord_bot.py --test

    - name: Run Discord Bot Test (Production Environment)
      if: github.event.inputs.environment == 'production'
      env:
        DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        ALLOWED_VOICE_CHANNEL_IDS: ${{ secrets.ALLOWED_VOICE_CHANNEL_IDS }}
      run: |
        echo "🤖 Discord Bot接続テスト（本番環境）"
        echo "⚠️ 注意: 本番環境のBotをテストしています"
        python tst/test_discord_bot.py
    
    - name: Test Success Summary
      if: success()
      run: |
        echo "✅ Discord Bot接続テスト成功"
        echo ""
        echo "確認項目:"
        echo "  ✅ Botトークンの有効性"
        echo "  ✅ サーバーへの接続"
        echo "  ✅ VCチャンネルへのアクセス"
        echo "  ✅ メンバー情報の取得"
    
    - name: Test Failed Summary
      if: failure()
      run: |
        echo "❌ Discord Bot接続テスト失敗"
        echo ""
        echo "トラブルシューティング:"
        echo "1. GitHub Secretsの設定を確認"
        echo "   - テスト環境: TST_DISCORD_BOT_TOKEN"
        echo "   - 本番環境: DISCORD_BOT_TOKEN"
        echo ""
        echo "2. Botの権限を確認"
        echo "   - SERVER MEMBERS INTENT が有効か"
        echo "   - Botがサーバーに追加されているか"
        echo ""
        echo "3. トークンの有効性を確認"
        echo "   - Discord Developer Portalで再生成が必要かも"
        exit 1