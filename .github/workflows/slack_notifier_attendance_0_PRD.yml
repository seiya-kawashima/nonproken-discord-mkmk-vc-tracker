name: æ—¥æ¬¡é›†è¨ˆå‡¦ç†ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã«å®Ÿè¡Œ
    # cronå¼: åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥ï¼ˆ0:æ—¥æ›œã€1:æœˆæ›œ...6:åœŸæ›œï¼‰
    - cron: '0 10 * * 0-4'    # JST 19:00ï¼ˆæœˆæ›œã€œé‡‘æ›œï¼‰
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      skip_holiday_check:
        description: 'ç¥æ—¥ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  daily-aggregate:
    name: ç¥æ—¥ãƒã‚§ãƒƒã‚¯ã¨æ—¥æ¬¡é›†è¨ˆå‡¦ç†
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install jpholiday  # æ—¥æœ¬ã®ç¥æ—¥åˆ¤å®šç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

    - name: ç¥æ—¥ãƒã‚§ãƒƒã‚¯
      id: holiday_check
      if: github.event_name != 'workflow_dispatch' || github.event.inputs.skip_holiday_check != 'true'
      run: |
        python << 'EOF'
        import sys
        from datetime import datetime
        import jpholiday
        import pytz

        # JSTã§ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
        jst = pytz.timezone('Asia/Tokyo')
        today = datetime.now(jst).date()

        # ç¥æ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        is_holiday = jpholiday.is_holiday(today)
        holiday_name = jpholiday.is_holiday_name(today)

        # åœŸæ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        is_weekend = today.weekday() >= 5  # 5:åœŸæ›œ, 6:æ—¥æ›œ

        if is_holiday:
            print(f"ä»Šæ—¥ã¯ç¥æ—¥ã§ã™: {holiday_name}")
            print("::set-output name=skip::true")
            sys.exit(0)
        elif is_weekend:
            weekday_names = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥']
            print(f"ä»Šæ—¥ï¼ˆ{today}ï¼‰ã¯{weekday_names[today.weekday()]}æ›œæ—¥ï¼ˆé€±æœ«ï¼‰ã§ã™")
            print("::set-output name=skip::true")
            sys.exit(0)
        else:
            print(f"ä»Šæ—¥ï¼ˆ{today}ï¼‰ã¯å¹³æ—¥ã§ã™")
            print("::set-output name=skip::false")
        EOF

    - name: æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ç¥æ—¥ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip_holiday_check == 'true'
      run: |
        echo "ğŸ”§ æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã€ç¥æ—¥ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"

    - name: æ—¥æ¬¡é›†è¨ˆå‡¦ç†ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      if: (steps.holiday_check.outputs.skip != 'true') || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_holiday_check == 'true')
      env:
        DISCORD_BOT_TOKEN_0_PRD: ${{ secrets.DISCORD_BOT_TOKEN_0_PRD }}
        GOOGLE_SERVICE_ACCOUNT_JSON_BASE64_0_PRD: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64_0_PRD }}
        GOOGLE_SHARED_DRIVE_ID_0_PRD: ${{ secrets.GOOGLE_SHARED_DRIVE_ID_0_PRD }}
        DISCORD_VOICE_CHANNEL_IDS_0_PRD: ${{ secrets.DISCORD_VOICE_CHANNEL_IDS_0_PRD }}
        SLACK_BOT_TOKEN_0_PRD: ${{ secrets.SLACK_BOT_TOKEN_0_PRD }}
        SLACK_CHANNEL_ID_0_PRD: ${{ secrets.SLACK_CHANNEL_ID_0_PRD }}
      run: |
        echo "æœ¬ç•ªç’°å¢ƒã§æ—¥æ¬¡é›†è¨ˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™"
        python slack_notifier_attendance.py --env 0

    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥ï¼ˆæˆåŠŸï¼‰
      if: success() && ((steps.holiday_check.outputs.skip != 'true') || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_holiday_check == 'true'))
      run: |
        echo "âœ… æ—¥æ¬¡é›†è¨ˆå‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰"
        echo "Slackã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ"

    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
      if: failure()
      run: |
        echo "âŒ æ—¥æ¬¡é›†è¨ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰"
        echo "ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

    - name: ä¼‘æ—¥ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
      if: steps.holiday_check.outputs.skip == 'true' && github.event_name != 'workflow_dispatch'
      run: |
        echo "ğŸŒ æœ¬æ—¥ã¯ä¼‘æ—¥ã®ãŸã‚ã€æ—¥æ¬¡é›†è¨ˆå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"

    - name: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          logs/
        retention-days: 7