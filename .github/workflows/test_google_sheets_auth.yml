name: Google Sheets èªè¨¼è¨ºæ–­ãƒ†ã‚¹ãƒˆ

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    inputs:
      test_type:
        description: 'ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api_check
          - sheets_list
          - create_test

jobs:
  è¨ºæ–­ãƒ†ã‚¹ãƒˆ:
    runs-on: ubuntu-latest

    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install gspread google-auth google-auth-oauthlib google-auth-httplib2

    - name: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã‚’å¾©å…ƒ
      env:
        TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
      run: |
        echo "$TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > service_account.json
        echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

    - name: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
      run: |
        echo "ğŸ“‹ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±:"
        python3 -c "
        import json
        with open('service_account.json', 'r') as f:
            data = json.load(f)
            print(f'  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: {data.get(\"project_id\", \"ä¸æ˜\")}')
            print(f'  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¡ãƒ¼ãƒ«: {data.get(\"client_email\", \"ä¸æ˜\")}')
            print(f'  ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ID: {data.get(\"private_key_id\", \"ä¸æ˜\")[:8]}...')
        "

    - name: Google APIsæœ‰åŠ¹åŒ–çŠ¶æ…‹ã‚’ç¢ºèª
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'api_check' }}
      run: |
        echo "ğŸ” Google APIsæœ‰åŠ¹åŒ–çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
        python3 << 'EOF'
        import gspread
        from google.oauth2.service_account import Credentials
        import json

        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        with open('service_account.json', 'r') as f:
            creds_data = json.load(f)

        # å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]

        try:
            # èªè¨¼æƒ…å ±ã‚’ä½œæˆ
            creds = Credentials.from_service_account_info(creds_data, scopes=scopes)
            print("âœ… èªè¨¼æƒ…å ±ã®ä½œæˆã«æˆåŠŸ")

            # gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
            client = gspread.authorize(creds)
            print("âœ… gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«æˆåŠŸ")

            # APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆç©ºã®ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼‰
            try:
                sheets = client.openall()
                print(f"âœ… Google Sheets APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸï¼ˆ{len(sheets)}å€‹ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œå‡ºï¼‰")
            except Exception as e:
                if "Google Sheets API has not been used" in str(e):
                    print("âŒ Google Sheets APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                    print("   Google Cloud Consoleã§æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„")
                elif "Google Drive API has not been used" in str(e):
                    print("âŒ Google Drive APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                    print("   Google Cloud Consoleã§æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„")
                else:
                    print(f"âš ï¸ APIç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")

        except Exception as e:
            print(f"âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: {e}")
            exit(1)
        EOF

    - name: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'sheets_list' }}
      run: |
        echo "ğŸ“Š ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§:"
        python3 << 'EOF'
        import gspread
        from google.oauth2.service_account import Credentials
        import json

        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        with open('service_account.json', 'r') as f:
            creds_data = json.load(f)

        # å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]

        try:
            # èªè¨¼æƒ…å ±ã‚’ä½œæˆ
            creds = Credentials.from_service_account_info(creds_data, scopes=scopes)

            # gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
            client = gspread.authorize(creds)

            # ã™ã¹ã¦ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—
            sheets = client.openall()

            if len(sheets) == 0:
                print("âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“")
                print("   ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¦ãã ã•ã„")
            else:
                print(f"âœ… {len(sheets)}å€‹ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:")
                for sheet in sheets:
                    print(f"   - {sheet.title} (ID: {sheet.id})")

            # ç‰¹å®šã®ã‚·ãƒ¼ãƒˆã‚’æ¢ã™
            target_names = ['VCãƒˆãƒ©ãƒƒã‚«ãƒ¼_TST', 'VCãƒˆãƒ©ãƒƒã‚«ãƒ¼', 'VC_Tracker_Test']
            print("\nğŸ” ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®æ¤œç´¢:")
            for name in target_names:
                try:
                    sheet = client.open(name)
                    print(f"   âœ… '{name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ (ID: {sheet.id})")
                except gspread.SpreadsheetNotFound:
                    print(f"   âŒ '{name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                except Exception as e:
                    print(f"   âš ï¸ '{name}' æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")

        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
            exit(1)
        EOF

    - name: ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆã®ä½œæˆã¨å‰Šé™¤ãƒ†ã‚¹ãƒˆ
      if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'create_test' }}
      run: |
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆã®ä½œæˆã¨å‰Šé™¤ãƒ†ã‚¹ãƒˆ:"
        python3 << 'EOF'
        import gspread
        from google.oauth2.service_account import Credentials
        import json
        from datetime import datetime

        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        with open('service_account.json', 'r') as f:
            creds_data = json.load(f)

        # å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]

        try:
            # èªè¨¼æƒ…å ±ã‚’ä½œæˆ
            creds = Credentials.from_service_account_info(creds_data, scopes=scopes)

            # gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
            client = gspread.authorize(creds)

            # ãƒ†ã‚¹ãƒˆç”¨ã‚·ãƒ¼ãƒˆå
            test_sheet_name = f"TEST_TEMP_{datetime.now().strftime('%Y%m%d_%H%M%S')}"

            try:
                # æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                print(f"ğŸ“ ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆ '{test_sheet_name}' ã‚’ä½œæˆä¸­...")
                sheet = client.create(test_sheet_name)
                print(f"   âœ… ä½œæˆæˆåŠŸ (ID: {sheet.id})")

                # ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
                worksheet = sheet.sheet1
                worksheet.update('A1', [['ãƒ†ã‚¹ãƒˆ', 'æˆåŠŸ'], ['Test', 'Success']])
                print("   âœ… ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿æˆåŠŸ")

                # ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
                values = worksheet.get_all_values()
                print(f"   âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚ŠæˆåŠŸ: {values}")

                # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤
                client.del_spreadsheet(sheet.id)
                print("   âœ… ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒˆå‰Šé™¤æˆåŠŸ")

            except Exception as e:
                print(f"   âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}")
                # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—è©¦è¡Œ
                try:
                    sheets = client.openall()
                    for s in sheets:
                        if s.title == test_sheet_name:
                            client.del_spreadsheet(s.id)
                            print("   ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")
                except:
                    pass
                exit(1)

        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
            exit(1)
        EOF

    - name: è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ“Š è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼"
        echo "=========================================="
        echo ""
        echo "âœ… æˆåŠŸã—ãŸé …ç›®:"
        echo "  - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã®å¾©å·åŒ–"
        echo ""
        echo "ç¢ºèªäº‹é …:"
        echo "1. Google Cloud Consoleã§ä»¥ä¸‹ã®APIãŒæœ‰åŠ¹ã‹ç¢ºèª:"
        echo "   - Google Sheets API"
        echo "   - Google Drive API"
        echo ""
        echo "2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ 'VCãƒˆãƒ©ãƒƒã‚«ãƒ¼_TST' ãŒå­˜åœ¨ã—ã€"
        echo "   ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç·¨é›†è€…æ¨©é™ã§å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
        echo ""
        echo "3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ã„ã‹ç¢ºèª"
        echo "=========================================="