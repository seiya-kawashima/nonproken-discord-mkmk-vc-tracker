name: Base64認証テスト

on:
  # 手動実行を許可
  workflow_dispatch:
  
  # PRとpush時に実行
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  test-base64:
    runs-on: ubuntu-latest
    name: Google Sheets Base64認証テスト
    
    steps:
    - name: コードをチェックアウト
      uses: actions/checkout@v4
    
    - name: Pythonセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install gspread google-auth python-dotenv
    
    - name: 環境変数チェック
      run: |
        echo "🔍 環境変数チェック"
        if [ -n "${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}" ]; then
          echo "  ✅ TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: 設定済み"
        else
          echo "  ❌ TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: 未設定"
        fi
    
    - name: Base64認証テスト実行
      env:
        TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        GITHUB_ACTIONS: 'true'
      run: |
        echo "🔐 Base64認証テストを実行（テスト環境）"
        python tst/test_base64_auth.py --env 1
        
    - name: テスト成功
      if: success()
      run: |
        echo "✅ Base64認証テスト成功"
        echo "Google SheetsへのBase64認証が正常に動作しています"
        
    - name: テスト失敗
      if: failure()
      run: |
        echo "❌ Base64認証テスト失敗"
        echo "GitHub Secretsの設定を確認してください:"
        echo "  - GOOGLE_SERVICE_ACCOUNT_JSON_BASE64"
        echo ""
        echo "Base64エンコード方法:"
        echo "  Linux/Mac: base64 -i service_account.json"
        echo "  Windows: [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes('service_account.json'))"
        exit 1