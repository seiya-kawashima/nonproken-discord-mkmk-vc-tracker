name: Base64èªè¨¼ãƒ†ã‚¹ãƒˆ

on:
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
  
  # PRã¨pushæ™‚ã«å®Ÿè¡Œ
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  test-base64:
    runs-on: ubuntu-latest
    name: Google Sheets Base64èªè¨¼ãƒ†ã‚¹ãƒˆ
    
    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install gspread google-auth python-dotenv
    
    - name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ” ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯"
        if [ -n "${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}" ]; then
          echo "  âœ… TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: è¨­å®šæ¸ˆã¿"
        else
          echo "  âŒ TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: æœªè¨­å®š"
        fi
    
    - name: Base64èªè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.TST_GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        GITHUB_ACTIONS: 'true'
      run: |
        echo "ğŸ” Base64èªè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒï¼‰"
        python tst/test_base64_auth.py --env 1
        
    - name: ãƒ†ã‚¹ãƒˆæˆåŠŸ
      if: success()
      run: |
        echo "âœ… Base64èªè¨¼ãƒ†ã‚¹ãƒˆæˆåŠŸ"
        echo "Google Sheetsã¸ã®Base64èªè¨¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
        
    - name: ãƒ†ã‚¹ãƒˆå¤±æ•—
      if: failure()
      run: |
        echo "âŒ Base64èªè¨¼ãƒ†ã‚¹ãƒˆå¤±æ•—"
        echo "GitHub Secretsã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„:"
        echo "  - GOOGLE_SERVICE_ACCOUNT_JSON_BASE64"
        echo ""
        echo "Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹æ³•:"
        echo "  Linux/Mac: base64 -i service_account.json"
        echo "  Windows: [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes('service_account.json'))"
        exit 1