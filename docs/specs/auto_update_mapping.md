# Discord-Slackマッピング自動更新ツール仕様書

## 📌 このドキュメントについて
このツールは、DiscordとSlackのユーザー管理を効率化する自動化ツールです。以下の3つの主要機能により、手動でのマッピング作業を大幅に削減し、管理者の負担を軽減します。

## 🎯 機能概要
1. **新規ユーザー自動追加**: 出勤記録のCSVファイルから新しいDiscordユーザーを検出し、マッピングシートに自動追加
2. **Slackユーザー一覧出力**: Slackワークスペースの全ユーザー情報をスプレッドシートに出力
3. **未マッピング通知**: Discord IDはあるがSlack IDが未設定のユーザーを検出し、Slackに通知

## 📥 Input（入力）
| 項目 | 型 | 説明 | 例 |
|------|-----|------|-----|
| 環境引数 | int | 実行環境の指定（0=本番、1=テスト、2=開発） | `--env 2` |
| CSVファイル | CSV | Google Drive上の出勤記録CSV | `もくもく会_PRD.csv` |
| マッピングシート | Googleスプレッドシート | 既存のDiscord-Slackマッピング情報（configで設定） | 設定による |

## 📤 Output（出力）
| 項目 | 型 | 説明 | 例 |
|------|-----|------|-----|
| 更新されたマッピングシート | Googleスプレッドシート | 新規ユーザーが追加されたシート | Discord IDと名前のみ入力済み |
| Slackユーザー一覧シート | Googleスプレッドシート | Slack全ユーザーの情報 | `slack_users_list` |
| Slack通知 | Slackメッセージ | 未マッピングユーザーの通知 | "〇〇さんの紐付けがされていません" |
| ログ出力 | テキスト | 処理結果のログ | "3人の新規ユーザーを追加" |

## 🔧 処理の流れ

### 1. 初期化フェーズ
1. 環境設定の読み込み（本番/テスト/開発）
2. Google Drive/Sheets APIの認証・初期化
3. Slack APIクライアントの初期化
4. サービスアカウントによる認証情報の設定

### 2. CSVデータ収集フェーズ
1. 設定ファイルからCSVファイルパスのテンプレート取得
2. Google Drive上の指定フォルダを検索
3. すべてのCSVファイルをスキャン
4. 各CSVから以下の情報を抽出：
   - Discord User ID（user_id列）
   - Discord User Name（user_name列）
   - VC名（ファイル名から環境サフィックスを除去）

### 3. 既存データ確認フェーズ
1. マッピングシートの場所を特定
2. シート内の既存Discord IDをすべて取得
3. 既存ユーザーのセットを作成

### 4. 新規ユーザー特定フェーズ
1. CSVのユーザーと既存マッピングを比較
2. マッピングシートに存在しないDiscord IDを特定
3. 新規ユーザーリストを作成

### 5. データ追加フェーズ
1. 新規ユーザーがある場合のみ実行
2. マッピングシートの最終行の次から追加
3. 以下の形式でデータを追加：
   - A列: Discord User ID
   - B列: Discord User Name
   - C列: （空欄 - Slack IDは手動入力用）

## 💡 使用例

### コマンドライン実行例
```bash
# 開発環境で実行
python auto_update_mapping.py --env 2

# 本番環境で実行
python auto_update_mapping.py --env 0

# テスト環境で実行
python auto_update_mapping.py --env 1
```

### 実行結果例
```
============================================================
Discord-Slackマッピング自動更新を開始
環境: 開発
============================================================

📁 CSVファイルからユーザー情報を取得中...
CSVファイル 2個を発見
処理中: もくもく会_DEV.csv (VC: もくもく会)
処理中: 作業部屋_DEV.csv (VC: 作業部屋)
CSVから 15人のユニークユーザーを取得

📋 マッピングシートの既存データを確認中...
マッピングシート発見: [configで設定されたシート名]
マッピングシートに 12人の既存ユーザー

🔍 分析結果:
  - CSV内のユーザー数: 15
  - 既存マッピング数: 12
  - 新規ユーザー数: 3

➕ 新規ユーザーをマッピングシートに追加中...
✅ 3人の新規ユーザーをマッピングシートに追加
  - 田中太郎 (ID: 123456789, VC: もくもく会)
  - 山田花子 (ID: 987654321, VC: 作業部屋)
  - 佐藤次郎 (ID: 456789123, VC: もくもく会)

============================================================
処理完了
============================================================
```

## ⚠️ 注意事項

### 権限関連
- Google Drive APIとSheets APIへのアクセス権限が必要
- サービスアカウントに適切な共有設定が必要
- 共有ドライブを使用する場合は、サービスアカウントをメンバーとして追加

### データ整合性
- Discord IDの重複チェックは自動実行
- Slack IDは空欄のまま追加（手動入力が必要）
- 既存のデータは変更・削除されない（追加のみ）

### エラー処理
- CSVファイルが見つからない場合は警告を出力して続行
- マッピングシートが見つからない場合はエラー終了
- API制限に達した場合は自動リトライなし

## ❓ FAQ

### Q: どのくらいの頻度で実行すべきですか？
A: 1日1回、夜間バッチとして実行することを推奨します。新規ユーザーの追加頻度に応じて調整してください。

### Q: Slack IDは自動で入力されますか？
A: いいえ、Slack IDは手動で入力する必要があります。このツールはDiscord IDと名前のみを自動追加します。

### Q: 既存のユーザー情報は更新されますか？
A: いいえ、このツールは新規ユーザーの追加のみを行います。既存データの更新は行いません。

### Q: 複数のVCからユーザーを収集できますか？
A: はい、設定されたフォルダ内のすべてのCSVファイルから自動的にユーザー情報を収集します。

### Q: エラーが発生した場合はどうなりますか？
A: エラーログが出力されますが、処理は停止します。ログを確認して問題を解決してから再実行してください。

## 🔧 設定ファイル関連
このツールは`config.py`の設定を使用します。以下の設定項目が必要です：

- `google_drive_service_account_json`: サービスアカウント認証ファイルパス
- `google_drive_csv_path`: CSVファイルのパステンプレート
- `google_drive_shared_drive_id`: 共有ドライブID（オプション）
- `google_drive_discord_slack_mapping_sheet_path`: マッピングシートのパス
- `google_drive_discord_slack_mapping_sheet_tab_name`: マッピングシートのタブ名
- `suffix`: 環境サフィックス（PRD/TST/DEV）