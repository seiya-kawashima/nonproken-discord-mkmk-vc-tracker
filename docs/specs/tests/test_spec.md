# テスト仕様書

## 📌 このドキュメントについて

このドキュメントは、**プログラムが正しく動くことを確認するためのテスト（品質チェック）**の設計書です。
車の車検のように、システムの各部品が正常に動作することを確認する方法を、初心者の方にも分かりやすく説明します。

---

## 1. 🎯 テストって何？なぜ必要？

### テストの役割
想像してみてください。新しい家電を買った時、**すべての機能が説明書通りに動くか確認する**ようなものです。プログラムも同じで、作った後に正しく動くかチェックが必要です。

### テストで確認すること
- ✅ **正常に動く？** - 期待通りの結果が出るか
- ✅ **エラーに強い？** - 問題が起きても壊れないか
- ✅ **速度は十分？** - 処理が遅すぎないか
- ✅ **安全性は？** - セキュリティに問題がないか

### テストがないと起きる問題
- ❌ 本番環境で突然エラーが発生
- ❌ データが消えたり壊れたりする
- ❌ お客様に迷惑がかかる
- ❌ 修正に時間とお金がかかる

---

## 2. 📊 テストの種類

### テストの階層（建物の検査のように）

#### 1. 単体テスト（部品チェック）🔧
**何をテスト？**
- 個々の機能（関数）が正しく動くか
- 例：電卓の「足し算」機能だけをテスト

**たとえば：**
```
テスト: 2 + 3 = ?
期待: 5
結果: 5 ✅ 合格！
```

#### 2. 統合テスト（組み合わせチェック）🔗
**何をテスト？**
- 複数の機能を組み合わせた時の動作
- 例：Discord + Sheets + Slack の連携

**たとえば：**
```
テスト: VCの情報を取得 → Sheetsに記録 → Slackに通知
期待: すべて成功
結果: すべて成功 ✅ 合格！
```

#### 3. システムテスト（全体チェック）🏢
**何をテスト？**
- システム全体が期待通りに動くか
- 例：朝4時に自動実行されるか

---

## 3. 🎯 カバレッジ（テストの範囲）

### カバレッジとは？
**プログラムのどれくらいの部分がテストされているか**を示す指標です。
100%なら全部テスト済み、50%なら半分だけテスト済みという意味です。

### 現在のカバレッジ状況

| プログラム | テスト済み | 目標 | 状態 |
|------------|------------|------|------|
| メイン処理 | 91% | 90% | ✅ 達成！ |
| Discord Bot | 64% | 70% | ⚠️ もう少し |
| Google Sheets | 93% | 90% | ✅ 達成！ |
| Slack通知 | 79% | 80% | ⚠️ あと少し |
| **全体** | **83%** | **85%** | ⚠️ もう少し |

### カバレッジの見方
- 🟢 **90%以上**: とても良い！
- 🟡 **70-89%**: まあまあ良い
- 🔴 **70%未満**: 改善が必要

---

## 4. 🧪 具体的なテスト内容

### Discord Botのテスト

#### テスト1: 初期設定の確認
```
準備: Botトークンとチャンネルを設定
実行: Botを起動
確認: 設定が正しく保存されているか
```

#### テスト2: VCメンバーの取得
```
準備: 仮想のVCに3人を配置
実行: メンバー情報を取得
確認: 3人全員の情報が取れるか
```

#### テスト3: 空のVCの処理
```
準備: 誰もいないVC
実行: メンバー情報を取得
確認: エラーが出ないで空リストが返るか
```

### Google Sheetsのテスト

#### テスト1: 接続テスト
```
準備: 認証情報を設定
実行: Sheetsに接続
確認: 接続成功するか
```

#### テスト2: データ記録
```
準備: テスト用のデータ
実行: Sheetsに書き込み
確認: 正しく記録されるか
```

#### テスト3: 重複チェック
```
準備: 同じデータを2回送信
実行: 2回目の記録処理
確認: 重複が防げているか
```

### Slack通知のテスト

#### テスト1: 通常の通知
```
準備: ユーザー名と日数
実行: 通知を送信
確認: 正しいメッセージが送られるか
```

#### テスト2: 100日目の特別通知
```
準備: 100日目のデータ
実行: 通知を送信
確認: お祝いメッセージになっているか
```

#### テスト3: エラー処理
```
準備: わざと間違った設定
実行: 通知を試みる
確認: エラーが適切に処理されるか
```

---

## 5. 🛠️ テストの実行方法

### 開発者向け（コマンドライン）

#### すべてのテストを実行
```bash
pytest tests/
```

#### カバレッジを確認しながら実行
```bash
pytest --cov=src tests/
```

#### 結果をブラウザで見る
```bash
pytest --cov=src --cov-report=html tests/
# htmlcov/index.html をブラウザで開く
```

### 自動テスト（GitHub Actions）
- **いつ実行？**: コードを更新するたび
- **どこで確認？**: GitHubのActionsタブ
- **結果の見方**: ✅ 緑 = 成功、❌ 赤 = 失敗

---

## 6. 🎭 モック（仮想環境）について

### モックとは？
**本物の代わりに使うダミー**のことです。
テスト中に本物のDiscordやSlackに接続すると問題が起きるので、偽物を使います。

### なぜモックを使う？

| 理由 | 説明 | 例 |
|------|------|-----|
| **安全性** | 本番環境を壊さない | テストでSlackに大量通知しない |
| **速度** | テストが速くなる | ネットワーク待ち時間がない |
| **安定性** | 毎回同じ結果 | 外部サービスの影響を受けない |
| **コスト** | 無料でテスト | API使用料がかからない |

### モックの例
```python
# 本物のDiscord接続の代わり
偽のDiscord = モック
偽のDiscord.VCメンバー = ["田中", "鈴木", "山田"]

# テストで使用
結果 = プログラム.VCメンバー取得(偽のDiscord)
確認: 結果が["田中", "鈴木", "山田"]と同じか
```

---

## 7. ⚠️ テストでよくある問題と対処法

### 問題1: テストが失敗する
**原因と対処：**
- コードを変更した → テストも更新が必要
- 環境設定が違う → 設定を確認
- 依存ライブラリのバージョン → 更新または固定

### 問題2: テストが遅い
**原因と対処：**
- ネットワーク通信している → モックを使う
- 無駄な処理がある → 最適化
- テストが多すぎる → 並列実行

### 問題3: カバレッジが上がらない
**原因と対処：**
- エラー処理のテスト不足 → エラーケースを追加
- 条件分岐が複雑 → リファクタリング
- 外部APIの部分 → モックでカバー

---

## 8. 📈 テスト結果の見方

### コマンドライン出力の例
```
==================== test session starts ====================
collected 45 items

tests/test_discord_client.py ........... [ 24%]
tests/test_sheets_client.py ............ [ 51%]
tests/test_slack_notifier.py .......... [ 73%]
tests/test_poll_once.py ............ [100%]

---------- coverage report ----------
Name                     Stmts   Miss  Cover
--------------------------------------------
poll_once.py                44      4    91%
src/discord_client.py       50     18    64%
src/sheets_client.py        84      6    93%
src/slack_notifier.py       73     15    79%
--------------------------------------------
TOTAL                      251     43    83%

==================== 45 passed in 2.34s ====================
```

### 読み方
- **collected 45 items**: 45個のテストを実行
- **[24%]**: 進捗状況
- **45 passed**: 全部合格！
- **Cover 83%**: 全体の83%をテスト済み

---

## 9. 💡 よくある質問（FAQ）

### Q1: テストは誰が書くの？
**A:** 通常はプログラムを作った人が書きます。時には専門のテスターが書くこともあります。

### Q2: テストはいつ実行するの？
**A:** 
- コードを変更したとき（自動）
- 本番環境にデプロイする前（必須）
- 定期的なチェック（日次/週次）

### Q3: 100%カバレッジは必要？
**A:** 理想的ですが、現実的には80-90%で十分です。100%を目指すとコストが高くなります。

### Q4: テストが失敗したらどうする？
**A:** 
1. エラーメッセージを確認
2. 失敗したテストを個別に実行
3. コードかテストを修正
4. 再度テスト実行

### Q5: テストの追加は難しい？
**A:** 最初は難しく感じますが、既存のテストをコピーして修正すれば簡単に追加できます。

---

## 10. 🔧 メンテナンスとアップデート

### 定期的な確認事項

#### 毎週
- [ ] テストが全部合格しているか
- [ ] カバレッジが下がっていないか

#### 毎月
- [ ] 新機能のテストを追加したか
- [ ] 不要なテストを削除したか

#### 毎年
- [ ] テストツールの更新
- [ ] テスト戦略の見直し

---

## 11. 🚧 今後の改善予定

### 近い将来
- 📊 カバレッジ85%達成
- 🔄 テストの高速化
- 📱 UIテストの追加

### 長期的な目標
- AIを使った自動テスト生成
- より詳細なパフォーマンステスト
- セキュリティテストの強化

---

## 12. 📚 もっと詳しく知りたい方へ

### テスト用語集

| 用語 | 説明 |
|------|------|
| **pytest** | Pythonのテストツール |
| **カバレッジ** | テストがカバーする範囲 |
| **モック** | テスト用の偽物 |
| **アサーション** | 期待値との比較 |
| **CI/CD** | 自動テスト・デプロイ |
| **リグレッション** | 修正で別の部分が壊れること |

### テストピラミッド
```
        /\
       /  \  少数のE2Eテスト
      /    \
     /------\ 
    /        \ 統合テスト
   /          \
  /------------\
 /              \ 多数の単体テスト
/________________\
```

### 参考リンク
- [pytest Documentation](https://docs.pytest.org/) - テストフレームワーク
- [Coverage.py](https://coverage.readthedocs.io/) - カバレッジ測定
- [Python Testing 101](https://realpython.com/python-testing/) - 初心者向けガイド

---

## 📞 サポート

テストで問題が発生した場合は、以下の情報を準備してお問い合わせください：

1. **失敗したテスト名**
2. **エラーメッセージ**の全文
3. **変更した内容**
4. **実行環境**（OS、Pythonバージョン）
5. **実行したコマンド**

この仕様書は定期的に更新されます。最新版は常にこのファイルを参照してください。

---

*最終更新日: 2025年1月*