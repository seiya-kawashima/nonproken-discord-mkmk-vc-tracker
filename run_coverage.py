#!/usr/bin/env python
# ========================================
# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ========================================
# æ¦‚è¦: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®šã—ã€
#       è¦‹ã‚„ã™ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–‹ç™ºè£œåŠ©ãƒ„ãƒ¼ãƒ«
#
# ä½¿ã„æ–¹:
#   python run_coverage.py        # åŸºæœ¬å®Ÿè¡Œ
#   python run_coverage.py --html # HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ã§é–‹ã
#   python run_coverage.py --ci   # CIç’°å¢ƒç”¨ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã«exit 1ï¼‰
# ========================================

import subprocess  # å¤–éƒ¨ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
import sys  # ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨
import os  # OSã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãªã©ï¼‰
import webbrowser  # ãƒ–ãƒ©ã‚¦ã‚¶ã§HTMLã‚’é–‹ããŸã‚
import argparse  # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®å‡¦ç†
from pathlib import Path  # ãƒ‘ã‚¹æ“ä½œã‚’ç°¡æ½”ã«è¡Œã†ãŸã‚

def run_coverage():
    """ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’å®Ÿè¡Œ"""

    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®è¨­å®š
    parser = argparse.ArgumentParser(description='ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®šã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ')  # ãƒ‘ãƒ¼ã‚µãƒ¼ä½œæˆ
    parser.add_argument('--html', action='store_true', help='HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ã§é–‹ã')  # --htmlã‚ªãƒ—ã‚·ãƒ§ãƒ³
    parser.add_argument('--ci', action='store_true', help='CIç’°å¢ƒç”¨ï¼ˆå¤±æ•—æ™‚ã«exit 1ï¼‰')  # --ciã‚ªãƒ—ã‚·ãƒ§ãƒ³
    parser.add_argument('--verbose', '-v', action='store_true', help='è©³ç´°ãªå‡ºåŠ›ã‚’è¡¨ç¤º')  # -vã‚ªãƒ—ã‚·ãƒ§ãƒ³
    args = parser.parse_args()  # å¼•æ•°ã‚’è§£æ

    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    print("ğŸ§¹ æ—¢å­˜ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...")  # é€²æ—è¡¨ç¤º
    subprocess.run(['coverage', 'erase'], capture_output=True)  # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤

    # HTMLãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    htmlcov_path = Path('htmlcov')  # HTMLãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‘ã‚¹
    if htmlcov_path.exists():  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        import shutil  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ç”¨
        shutil.rmtree(htmlcov_path)  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
        print("   HTMLãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ")  # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

    # pytestã‚³ãƒãƒ³ãƒ‰ã®æ§‹ç¯‰
    pytest_cmd = ['pytest']  # åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰

    if not args.verbose:  # è©³ç´°å‡ºåŠ›ã§ãªã„å ´åˆ
        pytest_cmd.append('-q')  # é™ã‹ãƒ¢ãƒ¼ãƒ‰

    pytest_cmd.extend([
        'tst/',  # ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        '--tb=short',  # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚’çŸ­ç¸®è¡¨ç¤º
    ])

    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    print("\nğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")  # é€²æ—è¡¨ç¤º
    result = subprocess.run(pytest_cmd, capture_output=False)  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

    if result.returncode != 0:  # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆ
        print("\nâŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ")  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if args.ci:  # CIç’°å¢ƒã®å ´åˆ
            sys.exit(1)  # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§çµ‚äº†
        return False  # å¤±æ•—ã‚’è¿”ã™

    print("\nâœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ")  # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®è¡¨ç¤º
    print("\nğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ:")  # ãƒ¬ãƒãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼
    print("=" * 60)  # åŒºåˆ‡ã‚Šç·š

    # ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ¬ãƒãƒ¼ãƒˆ
    coverage_report = subprocess.run(
        ['coverage', 'report', '--show-missing'],  # ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ãªã„è¡Œã‚‚è¡¨ç¤º
        capture_output=False  # å‡ºåŠ›ã‚’ç›´æ¥è¡¨ç¤º
    )

    # ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã®å–å¾—
    coverage_json = subprocess.run(
        ['coverage', 'json', '-o', '-'],  # JSONå½¢å¼ã§å‡ºåŠ›
        capture_output=True,  # å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        text=True  # ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å–å¾—
    )

    if coverage_json.returncode == 0:  # JSONå–å¾—æˆåŠŸ
        import json  # JSONè§£æç”¨
        try:
            data = json.loads(coverage_json.stdout)  # JSONã‚’ãƒ‘ãƒ¼ã‚¹
            total_coverage = data['totals']['percent_covered']  # å…¨ä½“ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡

            print("\n" + "=" * 60)  # åŒºåˆ‡ã‚Šç·š
            print(f"ğŸ“ˆ å…¨ä½“ã®ã‚«ãƒãƒ¬ãƒƒã‚¸: {total_coverage:.2f}%")  # ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡è¡¨ç¤º

            # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒé–¾å€¤ã‚’ä¸‹å›ã‚‹å ´åˆã®è­¦å‘Š
            if total_coverage < 70:  # 70%æœªæº€ã®å ´åˆ
                print(f"âš ï¸  è­¦å‘Š: ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ70%æœªæº€ã§ã™ ({total_coverage:.2f}%)")  # è­¦å‘Šè¡¨ç¤º
                if args.ci:  # CIç’°å¢ƒã®å ´åˆ
                    sys.exit(1)  # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§çµ‚äº†
            elif total_coverage < 80:  # 80%æœªæº€ã®å ´åˆ
                print(f"ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’80%ä»¥ä¸Šã«æ”¹å–„ã—ã¾ã—ã‚‡ã†")  # æ”¹å–„ææ¡ˆ
            else:  # 80%ä»¥ä¸Šã®å ´åˆ
                print(f"ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ{total_coverage:.2f}%ã§ã™")  # ç§°è³›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        except json.JSONDecodeError:  # JSONè§£æã‚¨ãƒ©ãƒ¼
            pass  # ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–

    # HTMLãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆç¢ºèª
    if htmlcov_path.exists():  # HTMLãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆ
        index_path = htmlcov_path / 'index.html'  # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        print(f"\nğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: {index_path}")  # ç”Ÿæˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        if args.html:  # --htmlã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆ
            print("ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã„ã¦ã„ã¾ã™...")  # é–‹ãå‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            webbrowser.open(str(index_path.absolute()))  # ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã

    # ä½¿ç”¨/æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å¯è¦–åŒ–æƒ…å ±
    print("\nğŸ’¡ ä½¿ç”¨/æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®ç¢ºèªæ–¹æ³•:")  # ãƒ˜ãƒ«ãƒ—æƒ…å ±
    print("   1. HTMLãƒ¬ãƒãƒ¼ãƒˆ: htmlcov/index.html ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã")  # HTMLãƒ¬ãƒãƒ¼ãƒˆ
    print("   2. èµ¤ã„è¡Œ: ãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰")  # æœªã‚«ãƒãƒ¼è¡Œ
    print("   3. ç·‘ã®è¡Œ: ãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰")  # ã‚«ãƒãƒ¼æ¸ˆã¿è¡Œ
    print("   4. é»„è‰²ã„è¡Œ: éƒ¨åˆ†çš„ã«ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆåˆ†å²ãªã©ï¼‰")  # éƒ¨åˆ†ã‚«ãƒãƒ¼

    # JSON/XMLãƒ¬ãƒãƒ¼ãƒˆã®æ¡ˆå†…
    print("\nğŸ“‹ ãã®ä»–ã®ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼:")  # ãã®ä»–ã®ãƒ¬ãƒãƒ¼ãƒˆ
    print("   - coverage.xml: CI/CDãƒ„ãƒ¼ãƒ«é€£æºç”¨")  # XMLãƒ¬ãƒãƒ¼ãƒˆ
    print("   - coverage.json: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã®è§£æç”¨")  # JSONãƒ¬ãƒãƒ¼ãƒˆ

    return True  # æˆåŠŸã‚’è¿”ã™

if __name__ == "__main__":  # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
    # é–‹ç™ºç’°å¢ƒã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‹ç¢ºèª
    try:
        import pytest  # pytestãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã‹ç¢ºèª
        import coverage  # coverageãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã‹ç¢ºèª
    except ImportError:  # ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        print("âš ï¸  å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        print("ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:")  # æŒ‡ç¤º
        print("  pip install -r requirements-2-dev.txt")  # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
        sys.exit(1)  # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§çµ‚äº†

    # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã‚’å®Ÿè¡Œ
    success = run_coverage()  # ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ

    if not success:  # å¤±æ•—ã—ãŸå ´åˆ
        sys.exit(1)  # ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§çµ‚äº†